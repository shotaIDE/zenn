---
title: "トランクベース開発におけるメリットとデメリット"
emoji: "🚄"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["トランクベース開発"]
published: false
---

こんにちは、モバイルエンジニアのころむにーです。

普段は、モバイルアプリを通じたユーザーへの価値提供を目指すプロジェクトに、技術リードという立場で参画しています。

この記事では、トランクベース開発について私個人が考えていることをまとめてみます。

# はじめに

トランクベース開発は、シンプルかつ強力な開発方法です。

https://dora.dev/capabilities/trunk-based-development/

上手く運用できれば、開発チームのパフォーマンスを最大限引き出し、爆速の開発を実現できます。

しかし、実際にプロジェクトで運用してみると、メリットは大きいものも、それなりにデメリットもあると感じました。

本記事では、私が実際にトランクベース開発を導入し、運用している中で感じたメリットとデメリットを具体的なシーンを含めて簡単にまとめてみます。

# トランクベース開発の概要

トランクベース開発とは、1 つのメインブランチ（トランクブランチ）を中心に開発を進める方法です。

以下のような開発でよくある課題を解決できることが特徴です。

- 長期間生存してきたブランチをマージする際、コンフリクトが発生しやすい
- 一部のメンバーだけで修正を長期間管理することで、早期に多くのメンバーからのフィードバックを得られにくい
- マージを止める期間が発生することにより、開発スピードが鈍化する

トランクベース開発では例えば「1 日を超える生存期間を持つブランチを複数許容しない」というルールを設けます。

それに伴い、以下のような開発フローとなります。

- 開発者はトランクブランチに対して、1 日未満の作業単位で細かくコミットしたり PR をマージしたりする
- 基本的にはトランクブランチ上のみでテストや CI を実行し、品質を担保する
- トランクブランチ上の最新コミットを、基本的にはそのまま本番リリースする

機能開発途中のコードが本番リリースされるのは普通となるので、フィーチャートグルなどを用いてリリースされても公開はされないようにするなどのロールアウト制御の仕組みを併用することがほぼ必須です。

# メリット

Git-flow や GitLab-flow、GitHub-flow などのブランチ戦略と比較し、実際に感じたメリットを記載していきます。

## ブランチ管理が限りなく簡単になり、コストやリスクが低減する

トランクベース開発では、全ての開発用ブランチを 1 日以内にトランクブランチへマージします。
また、リリースのときにはトランクブランチからリリースブランチを切り、数日間保持します。

つまり、**1 日を超えた生存期間を持つブランチはトランクブランチとリリースブランチの 2 種類だけ**になります。
そのため、限りなく簡単なブランチ管理が可能になります。

これにより、以下のようなメリットがあります。

- ブランチ管理のコストがほとんどなくなり、機能開発などの価値提供に使うコストが増える
- マージ時のコンフリクトを解消する機会がほとんどなくなり、解消ミスによるリスクがほとんどなくなる
- ブランチ管理やコンフリクト解消は難易度が高く、特定の熟練したメンバーだけにコストが集中することを防げる

実際に私が経験しているプロジェクトでは、以下のような定性的な効果がありました。

> トランクベース開発の運用フローが安定しているここ半年間くらいは、コンフリクトを解消する機会がほとんどなくなった。

> コード修正をどのブランチにマージすればいいかなどのコミュニケーションがなくなり、ブランチ管理のコストが大幅に削減された。

## 1 本のブランチ上で開発、テスト、自動チェック(CI)を集中することで、これらのコストパフォーマンスを最大化できる

主要なブランチが複数存在しないため、**1 本のブランチ上で開発、テスト、自動チェック(CI)を高サイクルに回すことが可能**になります。
これにより、以下のようなメリットがあります。

- 高頻度で自動・手動リグレッションテストを回すことができ、常に一定の品質を担保しやすくなる
- 開発者が全員で 1 つの状態のコードを触るため、全員の知見が早期に共有されやすくなる

実際のプロジェクトでは、以下のようなシーンがありました。

> リグレッションテストにより、開発途中の機能のデグレが早期に検知された。

> 機能 A のコード修正がトランクブランチにマージされたあと機能 B に関するコード修正のビルドが通らなくなり、機能 B と機能 A の依存関係が新しく発覚した。

## デプロイとロールアウトの分離が強制されることで、副次的に開発プロセスやプロダクトに柔軟性が生まれる

前述した通り、トランクベース開発では、機能開発のコードがデプロイされたとしても機能のロールアウト（発動）を別の仕組みで制御できるようにすることがほぼ必須です。

これにより、**副次的にいくつかのメリット**が発生します。

- 開発プロセスの早い段階でデプロイのことを考える必要があり、不確実性を早期に減少させられる
- ロールアウトにおけるリスクへの対策の選択肢が増える
- ロールアウトにおけるビジネス的な要求に対して柔軟に対応できる
- 一般ユーザーのベータ機能への早期アクセスなどの仕組みが容易に導入できる

実際のプロジェクトでは、以下のようなシーンがありました。

> 「機能 A の開発着手したいんだけど、これってフィーチャートグルつける必要あるかな？」
> 「これはサーバー側の特定のファイルがデプロイされることで機能が発動するようにできるから、フィーチャートグルは不要だね。」
> 「そうするとリリース時に問題が発生してサーバー側のファイルがロールバックされた時も、クライアント側が動作するように設計しておく必要あるね。」

> 「機能 A はデータベースへの書き込みが増加するから負荷が心配だね。もし問題が起きたらデプロイされたコード全体をロールバックするのではなくこの機能だけをロールバックしようか。」

> 「機能 C は来週リリースだったんだけど、別のリリースと合わせて公開したいから来月に遅らせることできる？」
> 「その機能はフィーチャートグルを ON にするだけだから問題なくできるよ！」

# デメリット

以下では、実際に感じたデメリットを記載していきます。

## デプロイとロールアウトを分離する必要があるため、開発の複雑性が増し、学習コストが高くなる

デプロイとロールアウトの分離を実施する場合、以下のように**開発、テスト、運用などのプロセスがそれぞれ複雑化**します。

- コード上でフィーチャートグルを管理し、ON/OFF 時の挙動の分岐を管理する
- フィーチャートグル ON/OFF 両方の状態でテストを行う
- 動作中にフィーチャートグルが動的に切り替わるパターンを想定している（Ops トグルを想定している）場合は、ON と OFF を行き来するテストを行う
- フィーチャートグル切り替えを行う運用コストが発生する
- フィーチャートグルの分岐や定義を削除するメンテナンスを行う
- 監視やログの設計をフィーチャートグルを考慮したものにする

これにより、**各プロセスに必要な工数が少しずつ増え、メンバー間のコミュニケーションコストも少しずつ増えていきます**。

具体的には以下のようなコミュニケーションが発生します。

> 「機能 A はフィーチャートグルを使って実装しましょう。フィーチャートグル OFF の場合は、機能 A が表示されないようにしてください。」

> 「今回のリリースに機能 B の途中までの修正が含まれますが、フィーチャートグル OFF 状態のままとするので、一般ユーザーには機能 B が見えることはありません。」

> 「今回のリリースには機能 C が含まれます。機能 C はフィーチャートグルを使って実装しているため、リリース時にフィーチャートグルを ON にする必要があります。」

さらに、**プロダクトオーナーやビジネスサイドのメンバーにも説明が必要**になってきます。

例えば、以下のようなコミュニケーションが発生します。

> 「機能 A は来週月曜日から 2 週間かけて一般ユーザーに徐々に開放されていきます。」

> 「機能 B は来週月曜日に全ユーザーへ公開されます。もし、監視で問題が発生した場合は、すぐに機能 B を無効化します。」

こうしたコミュニケーションは、プロダクトの外部への発信やユーザーへのサポートなどに必要です。

## 品質基準やリリース計画とは関係なくまぜこぜに修正が取り込まれていくため、予測可能性が下がる

トランクベース開発では、**必要最低限のコードを取捨選択**してリリースしデグレリスクを抑えるような、**厳格な品質基準を設定しにくくなります**。

トランクブランチは機能開発やバグ修正のコードが PR レビュー完了次第マージされていくため、**トランクブランチ上で一時的にデグレしている状況が起こりえます**。
そして、トランクベース開発ではトランクブランチの最新コミットをベースにリリースするため、一時的にデグレしている状況だと**そのままリリースされてしまう**リスクが高まります。

実際にプロジェクトでは以下のようなシーンがありました。

> 開発途中の機能 A の修正により機能 A 以外にデグレが発生し、そのデグレがリリースされてしまった。

これを防ぐために、**包括的な自動テストや高サイクルなリグレッションテストを高精度で行い**、デグレを早期に防いだり解消する取り組みを継続的に行うことが重要です。

一方で、重大度に関わらずデグレを流出させることがビジネスとして致命的になる状況では、トランクベース開発は向いていない可能性があります。

また、**バグ修正などの一部の修正**はロールアウトのタイミングをコントロールすることが難しいため、**リリース計画を立てたりリリースタイミングを調整することが難しくなります**。

フィーチャートグルなどをでバグが修正されていない状態と修正されている状態を切り替えることは一般的に難しい場合が多いです。
これは、バグ修正は一般的に複雑なコード修正を伴うため、フィーチャートグルで管理するコストが高くなるためです。
また、再現性の問題で、フィーチャートグルの切り替えに伴う動作確認が難しい場合もあります。

実際にプロジェクトでは以下のようなシーンがありました。

> バグ修正 A に関して、リリースにおける QA リソースの関係でリリースから外すことになった。この際、トランクブランチ上でバグ修正 A のコード修正をリバートし、一般ユーザーに修正がロールアウトされないように対応した。

トランクベース開発では、**バグ修正に関しては対応が終わった直後のリリースで順次公開していく取り決めをする**のが最もスムーズです。

一方で、バグ修正がユーザーにロールアウトされるタイミングを事前に計画し、コントロールしたいという要望が強い場合には、トランクベース開発は向いていない可能性があります。

# メリットとデメリットの比較

上記で見てきたように、トランクベース開発は、開発プロセスや品質担保を効率的に実現でき、副次的な効果として価値単位の柔軟なロールアウトが可能になることで運用リスクの低減や価値検証の柔軟性が高まります。
一方で、プロジェクトに関わる全員に対してキャッチアップコストが増加し、リリースタイミングのコントロール性が低くなります。

そのため、新しいものがウェルカムな雰囲気であり、リリースタイミングを柔軟に調整可能なプロジェクトでは、このあたりのデメリットが問題になりにくいため、導入しやすいと言えます。

私が参加しているプロジェクトでは、元々新しいものを取り入れることに前向きな文化があるという部分が当てはまっており、メリットが大きいと予想していたため、トランクベース開発を導入しました。

一方でいま、バグ修正がユーザーの手元で適用されるタイミングを完全にコントロールしたいという要求が出てきていて、その部分に対してはデメリットが大きくなっていると感じています。
プロジェクトの全体的な業務フローを整理して、適切な運用方法を検討中です。

# 最後に

本記事では、私が実際にトランクベース開発を導入し、運用している中で感じたメリットとデメリットを記載してみました。

トランクベース開発を導入する際には、メリットとデメリットを踏まえて、適切な運用方法を検討してみてください。
