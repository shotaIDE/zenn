---
title: "チーム開発をうまくやるために技術リードとして取り組んだ内容"
emoji: "🕌"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["ios", "android"]
published: false
---

こんにちは、モバイルエンジニアのころむにーです。

普段、モバイルアプリを通じたユーザーへの価値提供を目指すプロジェクトに、技術リードという立場で参加しています。

本記事では、今入っているプロジェクトで取り組んでいる内容について、紹介してみます。

# はじめに

継続的な価値提供するために不足している部分を補う取り組みを行いました。

前提として iOS/Android のモバイルアプリを開発するプロジェクトです。

- アプリのメトリクス可視化
  - 内部品質の定量的な指標の可視化
  - 開発プロセスのメトリクスの可視化
  - 主要な機能のパフォーマンス可視化

# 1. 価値提供の中身を、技術とそれ以外の領域で全体最適化する

## 1-1. 技術と仕様のバランスを取る

実現が技術的に難しい仕様は、サービスにとっての仕様の重要度と技術的なコストを踏まえて、妥協点を探る必要があります。

技術的に難しい仕様を開発者が人知れず頑張って実装してしまうと、機能開発時のスピードや今後のメンテナンス性の悪化につながります。

例えば、以下のような内容です。

## 1-2. バックエンドとフロントエンドのバランスを取る

仕様の実現の際、バックエンドとフロントエンドのどちらにロジックを寄せるかは、よく検討する必要があります。

実装時の妥当性と、今後の拡張性などもさまざまな要素を踏まえて、バランスを取る必要があります。

例えば、以下のような内容です。

- Web、iOS、Android で共通のロジックは、バックエンドに寄せる
- 既存の API の修正に関して、iOS、Android の古いアプリから呼び出されても問題ないよう後方互換性を保証する
- ユーザー操作にリアルタイムで反応させる機能の実現では、バックエンドへの負荷削減とレスポンス速度を優先しフロントエンドのロジックに寄せる
- 今後バックエンド側が機能拡張された際に、iOS、Android のアプリにおける致命的なバグが起こらないよう、異常系の処理を定義しておく

## 1-3. 外部環境の変化に対応する開発計画を組み込む

新しい OS バージョンへの対応や、ストアのポリシー変更などは、プロダクトオーナーがキャッチしてロードマップに組み込むことは難しいため、開発者から提案する必要があります。

こうした対応は、期限が決まっていることも多いため、早めに提案し、実装することが重要です。

例えば以下のような内容です。

- 新しい OS バージョンへの対応
- ストアのポリシー変更への対応
- ライブラリのサポート終了に伴うバージョンアップ

# 2. 価値提供のプロセスを全体最適化する

継続的に価値提供し続けたいというプロジェクトであったため、短いサイクルでのリリースに耐えうるプロセスを構築しました。

## 2-1. トランクベース開発の導入

トランクベース開発は、リリースのために大きなマージをするなどのイベントを減らし、リリースのスピードを上げることができます。

そのため、短いサイクルでのリリースに適していると考えているので、トランクベース開発を導入しました。

以下のような取り組みをしています。

- 1、2 日以内で完了するタスク単位に分割
- トランクブランチにおける高頻度の手動リグレッションテスト
- CI の導入
  - トランクブランチへの PR マージ前に静的解析、単体テストなどをチェックし、パスしていない場合はマージを禁止する
  - トランクブランチでの E2E テストを実行し、失敗した場合はすぐに修正する

## 2-2. デプロイとロールアウトの分離

ユーザーへの価値提供をできるだけ多く早く行いつつ、リスクやバグを最小限に抑えるため、デプロイとロールアウトを分離しました。

トランクベース開発を導入した際にはほぼ必須になる仕組みではあります。

このために、以下のような取り組みをしています。

- 設計時点で、ロールアウトの方式を決める
- 必要に応じてフィーチャートグルを導入する

# 3. 開発者のオーナーシップを実装以外の工程にも広げる

変化の早い環境で継続的に価値提供するためには、開発者が実装以外の工程に対してもオーナーシップを広げていくことが重要と考えます。

## 3-1. E2E テストの導入開始

- 開発メンバーによる自律的な E2E テストの追加とメンテナンス、精度向上の取り組み。開発メンバーが外部品質にオーナーシップをより持っていくことに繋げられそう

### E2E テストについて

#### E2E テストを運用することで、デグレを検知できる

プロダクトコード側で、選択肢ダイアログ表示中に別のダイアログが上に表示されてようになってしまい、選択肢ダイアログの操作がしづらくなりました。
つまり、操作性が悪くなるデグレでした。
E2E テストが失敗するようになったので、この事象を検知し修正できた。

#### E2E テストを実装することで間接的にプロダクトコードの品質向上に寄与している

テストの実行結果が不安定となる場合があり、それらはプロダクトコード側の品質が悪いことに原因があります。

- ネットワーク速度が遅いあるいは端末のスペックが低い場合に、正しい順番で処理が行われない
- プログラム中の準正常系、異常系のパターンが漏れている

#### 開発が立ち上がるまでのコストがそれなりに大きい

- CI 環境で、ネットワーク速度が遅かったり端末の動作が遅かったりする場合にもロバストに動くテストコードの書き方
- CI 環境で E2E テストを動かすための環境構築

#### メンテナンスのための開発者の作業コストが増える

- テストが失敗した際の調査
- 日々の機能追加や修正による、E2E テストコードの修正

#### 自動実行のための CI 環境の経済的コストがかかる

- マシンにある程度のスペックが求められるため、静的解析や単体テストを回すスペックよりも良いマシンスペックを選択したり、専用の SaaS を利用した方がいい

## 3-2. クラッシュレポートの定期的なトリアージ

# 4. プロジェクトのリスクを下げる

継続的な価値提供をするためには、リスクを低減する取り組みが必要です。

## 4-1. アプリのメトリクスに基づく意思決定

- Android プッシュ通知の EOL 対応

## 4-2. アプリが依存するライブラリのライセンス情報が変化したことを検知するためのツールの作成

- ライセンス違反に気づきやすくなった

## 4-3. リスク低減

- 各種ツールで利用する Ruby のバージョンを厳密に固定
- PR 提出時に、正しい Jira への紐付けを自動チェック

# 5. 内部品質を継続的に改善する

数ヶ月以上にわたって継続的に価値提供していくサービスにおいては、コードのメンテナンス性などの内部品質を高く保ち続ける取り組みが必須です。

内部品質が継続的に改善し続けないと、バグが増えるなどの外部品質に悪影響を及ぼし、機能提供のスピードが落ちていくなど、価値提供に悪影響を及ぼします。

そのため、以下のような内部品質を継続的に改善し続けるための取り組みを行いました。

## 5-1. 定量的に測れる内部品質が悪化しないようにするための CI

コードの内部品質が悪化しないようにすることが重要です。
エンジニア同士のコードレビューで指摘していく方法もありますが、CI で自動的にチェックすることで、エンジニアの負担を減らし、コードの品質を保つことができます。

以下のような取り組みを行いました。

- 静的解析による指摘事項が増えないようにする
- デッドコードが増えないようにする
- PR 提出時に、Typo が増えないことを自動チェック

これにより以下のような効果がありました。

- 静的解析による指摘事項が 0 になり、0 で維持することが当たり前になった
- デッドコードが増えないようになり、コードのメンテナンス性が向上した
- 静的解析やデッドコードなどを気にする動きがエンジニア間でみられるようになった

## 5-2. 開発プロセスやコード品質の定性的・定量的な測定と観察

リファクタリングや開発プロセスの改善の取り組みが正しい方向に進んでいるかの自信を持つために、それらの取り組みの効果を定量的・定性的に測定し、観察することが重要です。

以下のような取り組みを行いました。

- エンジニアメンバーによる開発プロセスに関する訂正的なアンケートの実施と集計
- コード品質のメトリクス(単体テストのコードカバレッジ)の定量的な測定と観察

これにより、以下のような効果がありました。

- コード品質が順調に維持・向上しているかを確認できるようになった
- 開発メンバーがコード品質のメトリクス(単体テストのコードカバレッジ)を意識する場面が見られた

# 6. 開発プロセスを効率化する

継続的な価値提供をするためには、開発プロセスを継続的に効率化する取り組みが必要です。

以下のような開発プロセスを効率化する取り組みを行いました。

## 6-1. 開発やテストを効率化するための仕組み

iOS や Android アプリでは、API を通じてデータのやり取りすることが多いです。
その際に、API のリクエストやレスポンスを確認したり、遅延や改ざんなどをしたりすることで、開発やテストに役立つことが多くあります。

そのため、以下のような取り組みを行いました。

- Fiddler や Charles などのプロキシーツールの使い方を簡単にドキュメントにまとめ、開発メンバーや QA が使いやすいようにした
- Web ソケットの通信をプロキシーツールで確認できるようにするため、アプリ内でプロキシー設定ができるようなデバッグ機能を実装

https://www.telerik.com/fiddler

https://www.charlesproxy.com/

実際に、プロキシーツールを使って、以下のようなことができるようになりました。

- ネットワークが遅い状況で再現するバグの調査がしやすくなった
- API 修正において、レスポンスを改ざんすることで、効率よく影響範囲を調査できるようになった

## 6-2. ワークフロー効率化

アプリに利用しているライブラリは、定期的にバージョンアップされています。
これを手動で行うと、手間がかかるだけでなく、対応漏れが発生する可能性もあります。

そのため、dependabot や Renovate などのツールを導入し、ライブラリのバージョンアップの PR が自動で作成されるようにしました。

https://docs.github.com/ja/code-security/dependabot/working-with-dependabot

https://docs.renovatebot.com/

# その他メモ

- スプリント開発用のビルドのデプロイ自動化
- リリース用のビルドのデプロイ半自動化（トランクベース開発を考慮）
- E2E 自動テスト実行時の画面収録を蓄積
- E2E 自動テストにおけるテストケースと確認観点のドキュメントデプロイを自動化
