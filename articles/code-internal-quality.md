---
title: "コードの内部品質を高めて、継続的な価値提供を下支えする"
emoji: "🕌"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["ios", "android"]
published: false
---

コードの内部品質を高めて、継続的な価値提供を下支えするために、私が取り組んできたことをまとめました。

# 背景

チームメンバーの特徴として、以下のようなものがあります。

コンピューターサイエンスは学んでいて、プログラムを書くことは得意です。

一方で、コードの内部品質に関して、重要視しているメンバーもいればそうでないメンバーもいるという状況でした。

私は技術リードとしてジョインしていました。

# やっていること

- 正しい方向に向かうことの意識づけ
  - ミッションステートメントの制定・意識づけ
  - 日々の活動の中で背景を伝える
  - 情報格差をなくす
- 正しい方向に向かうことの運用
  - 草の根活動・手本を見せる
  - ガードレールによる仕組み化
  - 明文化
- 正しい方向に向かっていることの観測
  - データの可視化
  - フィードバックサイクルの確保

# 正しい方向に向かうことの意識づけ

## ミッションステートメントの制定・意識づけ

一人一人に対してマイクロに指示を出していくことは難しいです。
そのため、目指すべき方向性を抽象的に伝えるミッションステートメントを制定し、1 人 1 人に自律的に考えて工夫していってもらうようにしました。

具体的には以下のような内容を伝えました。

## 日々の活動の中で背景を伝える

メンバーにやってもらいたいことを伝えるとき、内容だけでなく、なぜそれをやってもらいたいのかを意識的に伝えるようにしました。

例えば以下のような内容です。

こうした取り組みを行うことで、折に触れてメンバーが目指すべき方向性を意識してもらえるように工夫しました。

## 情報格差をなくす

開発プロセスに関する情報格差があると、何にコストをかけるべきかが人によってばらつきが大きくなってしまいます。

情報格差をなくすために、以下のような取り組みを行いました。

# 正しい方向に向かうことの運用

## 草の根活動・手本を見せる

自分が実装する際に手本を見せたり、メンバーのコードレビュー時に指摘をすることで、メンバーに示すことができます。

## ガードレール

内部品質の向上に対して、仕組み化しました。

- 品質向上
  - PR 提出時に、静的解析の指摘が増えないことを自動チェック
  - PR 提出時に、デッドコードが存在しないことを自動チェック
  - PR 提出時に、Typo が増えないことを自動チェック

単体テストの導入、静的解析の導入。

E2E テストの導入。

- ワークフロー効率化
  - PR 提出時に、正しい Jira への紐付けを自動チェック
  - ライブラリ更新の PR を自動で作成
  - スプリント開発用のビルドのデプロイ自動化
  - リリース用のビルドのデプロイ半自動化（トランクベース開発を考慮）
- リスク低減
  - 各種ツールで利用する Ruby のバージョンを厳密に固定
- デバッグ効率
  - E2E 自動テスト実行時の画面収録を蓄積
- ドキュメンテーション
  - E2E 自動テストにおけるテストケースと確認観点のドキュメントデプロイを自動化
- アプリのメトリクス可視化
  - 内部品質の定量的な指標の可視化
  - 開発プロセスのメトリクスの可視化
  - 主要な機能のパフォーマンス可視化

## 現状の可視化

## 観測

## 安全にプロジェクトを進めるための新しい取り組み

- アプリのメトリクスに基づく意思決定
  - Android プッシュ通知の EOL 対応
- 定量的に測れる内部品質が悪化しないようにするための CI
  - 静的解析による指摘事項が増えないようにする
  - デッドコードが増えないようにする
- アプリが依存するライブラリのライセンス情報が変化したことを検知するためのツールの作成
  - ライセンス違反に気づきやすくなった

## 効率よくプロジェクトを進めるための新しい取り組み

- Android におけるライブラリ更新の手動作業を削減
  - 週次で 0.5pt 程度の作業がなくなった
- E2E テストの導入開始
  - 開発メンバーによる自律的な E2E テストの追加とメンテナンス、精度向上の取り組み。開発メンバーが外部品質にオーナーシップをより持っていくことに繋げられそう
- 開発プロセスやコード品質の定量的な測定と観察
  - コード品質が順調に維持・向上しているかを確認できるようになった
  - 開発メンバーがコード品質のメトリクス(単体テストのコードカバレッジ)を意識する場面が見られた
- 開発やテストを効率化するための仕組み
  - プロキシーツールに関するドキュメンテーションと動作確認・テストへの導入
  - Android の Web ソケットにおけるプロキシーでの可視化機能の導入

## 定性的な成果

- 内部品質に関する意識の向上
  - 週次のメンテナンスタスクの実施により、各メンバーが様々な内部品質に関するトピックに対して意識を向けるようになった
  - 単体テストコードの拡充に関して、自発的に提案
  - 開発メンバーが背景に関するコードコメントを書くようになった

## 開発チームや開発プロセスに対する理解

- トランクベース開発の効果、つらさ
  - 効果
    - 普段の開発作業における複雑なブランチ管理が不要、デプロイ手順の容易さ
    - リグレッションテストの手間を最小にできる
  - つらさ
    - トランクブランチの状態を常に一定以上の品質を保たないと、つらい
- 開発メンバーの強み・弱みの理解
  - 強み
    - 決められた外部仕様を確実に実装する
    - 外部仕様に決められていないエラーハンドリングを考慮
  - 弱み
    - サービスの中の相対的な価値を踏まえた仕様検討
    - 修正に対する既存実装の影響箇所の把握と、それを考慮した実装
    - デグレを防ぐために効果的な自動テストの実装
- 内部品質の向上のためのノウハウ
  - 実装方法を JP 側から具体的に提示する方法はあまりうまくいかなかった
  - 意識づけを行う（現状よりも内部品質をより高めていきつつ、リーダーだけでなく全員で取り組むなど）ことで、自律的に取り組んでいく様子が見られた

## プロジェクト遂行のマインドセット

- 開発者同士で前提知識を揃える
- 自己組織化

# 背景

継続的に価値を提供していくために、コードの内部品質改善というのは重要なトピックです。

コードの内部品質に関して、重要視しているメンバーもいればそうでないメンバーもいるという状況でしたので、以下の施策を取り組んできました。

- マインドセットの明文化
- 内部品質の定量的な指標の可視化
- PR レビューなどを通した草の根活動
- 継続的インテグレーションの導入

1 つ失敗として、内部品質の改善における内容や重要度を、開発メンバー以外が詳細に決めてしまうということをした点です。
こちらは、開発メンバーから内部品質に関するオーナーシップを奪う行為になってしまい、ただ言われたことをやるだけになってしまう様子が散見されました。

また、自動化できるものは自動化していきます。

## ガードレール

## 運用

- ルールは決めただけではダメで、正しく運用されるために、何度でもメンバーに働きかけをする
- フィードバックサイクル

# E2E テストの運用

## メリット

### E2E テストを運用することで、デグレを検知できる

プロダクトコード側で、選択肢ダイアログ表示中に別のダイアログが上に表示されてようになってしまい、選択肢ダイアログの操作がしづらくなりました。
つまり、操作性が悪くなるデグレでした。
E2E テストが失敗するようになったので、この事象を検知し修正できた。

### E2E テストを実装することで間接的にプロダクトコードの品質向上に寄与している

テストの実行結果が不安定となる場合があり、それらはプロダクトコード側の品質が悪いことに原因があります。

- ネットワーク速度が遅いあるいは端末のスペックが低い場合に、正しい順番で処理が行われない
- プログラム中の準正常系、異常系のパターンが漏れている

## デメリット

### 開発が立ち上がるまでのコストがそれなりに大きい

- CI 環境で、ネットワーク速度が遅かったり端末の動作が遅かったりする場合にもロバストに動くテストコードの書き方
- CI 環境で E2E テストを動かすための環境構築

### メンテナンスのための開発者の作業コストが増える

- テストが失敗した際の調査
- 日々の機能追加や修正による、E2E テストコードの修正

### 自動実行のための CI 環境の経済的コストがかかる

- マシンにある程度のスペックが求められるため、静的解析や単体テストを回すスペックよりも良いマシンスペックを選択したり、専用の SaaS を利用した方がいい

# まとめ

1 年程度実施してきましたが、以下のような成果がありました。
