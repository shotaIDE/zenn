---
title: "コードの内部品質を高める動きをチームに浸透させたい"
emoji: "🥝"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["チーム開発", "品質", "リファクタリング"]
published: false
---

<!-- cspell:ignore detekt, qodana -->

こんにちは、モバイルエンジニアのころむにーです。

普段、モバイルアプリを通じたユーザーへの価値提供を目指すプロジェクトに、技術リードという立場で参加しています。

本記事では、コードの内部品質について、私が直近のプロジェクトで取り組んできたことをまとめました。

## 背景

プロダクトで継続的に価値を提供していくために、コードの内部品質を高く保つのは重要です。

内部品質は目に見えにくく定量的な成果が出にくいものであるものの、中・長期的にビジネスの成長に大きく影響してきます。

私がジョインした開発チームでは、内部品質に対する意識がまちまちでした。
コードの内部品質に関して、重要視しているメンバーもいればそうでないメンバーもいるという状況でした。

その中で、技術リードとして、内部品質をチーム全員で高めていくために取り組んできた内容を振り返ってみます。

## 私の立場

## この記事で書くこと

## この記事の読み方

## やってきたことの概要

以下のように、大きく分けて 3 つの観点から取り組んできました。

1. 意識づけ
2. 運用
3. 観測

それぞれを詳しく見ていきます。

## 1. 正しい方向に向かうことの意識づけ

### 1-1. ミッションステートメントの制定やマインドセットの共有

ある程度の規模のチームであると、1 人 1 人の全ての作業に対してマイクロに指示を出していくことは現実的でないです。
そのため、目指すべき方向性を抽象的に伝えるミッションステートメントを制定し、1 人 1 人に自律的に考えて行動してもらえるようにしました。

具体的には以下のような内容を伝えました。

リードエンジニアたちに対してのミッションを以下のように設定しました。

> 各エンジニアが、自立し、かつ自信を持って開発を進められるよう、必要な能力の伝授や仕組み化を推進する

また、メンバーエンジニアに対しては以下のように設定しました。

> チーム全体で内部品質を高め、困難なバグ対応に苦しむことなく、クールに価値提供していけるチームを目指す

また、マインドセットとしては、以下のようなものを伝えました。

- いつやるか？ → 全てのタスクで
- 誰がやるか？ → 全員で
- どうやるのか？
  - スピードよりも内部品質の高さを優先する
  - 短いコードよりも、誰がみても誤解しないコードを目指す。
  - 修正する範囲のベストよりも、既存コード全体でベターな書き方を目指す。

### 1-2. 日々の活動の中で背景を伝える

メンバーに何かやってもらいたいとき、やってもらう内容だけでなく、なぜそれをやってもらいたいのかという背景や意図を明確に伝えるようにしました。
こうした取り組みを行うことで、折に触れてメンバーが目指すべき方向性を意識してもらえるように工夫しました。

例えば、コードレビューで指摘する際に、以下のようなコメントをするような取り組みを行いました。

> この実装方法を採用した背景をコードコメントとして残しておいて欲しいです！
>
> 以下が背景です！
>
> - **後からこのコードを見た際に、実装時の背景を考慮せずに変更を加えて意図せずバグを発生させることを防ぐ**

### 1-3. 正しい方向が重要だと目線を合わせる

開発プロセスの問題を把握するための情報に関して、メンバー間で把握している情報の格差があると、課題感の重要度などの目線が揃わなくなってしまいます。
これにより、今取り組んでいる改善が本当に重要なのかの目線を合わせづらくなり、全員で課題に一丸となって取り組むことができなくなります。

情報格差をなくすために、以下のような取り組みを行いました。

- 定量的に見える情報をダッシュボード化して、全員が見えるようにする
  - これは後述するものと関連します
- チーム内での課題共有や目指したい方向の共有を積極的に行う
  - これは後述するものと関連します

## 2. 正しい方向に向かうことの運用

### 2-1. 一定のコストで取り組まれることを保証する

短期的な成果が見えにくい内部品質向上の取り組みは、他の業務に比べて優先度が低くなりがちです。

特に機能開発やバグ修正など、ユーザーに直接価値を提供するプレッシャーが強いと、内部品質向上の取り組みが後回しになりがちです。

一番簡単な方法は、内部品質向上の取り組みに対して、常に一定のコストを用意することです。

このプロジェクトでは、以下の方針を採用しました。

- 毎スプリントの 1 〜2 割程度のコストを内部品質向上に充てる

> 週次のメンテナンスタスクの実施により、各メンバーが様々な内部品質に関するトピックに対して意識を向けるようになりました。
> 具体的には、コードのリファクタリングやドキュメントの更新などが行われ、これによりプロジェクト全体の可読性と保守性が向上しました。

> 開発メンバーが背景に関するコードコメントを書くようになりました。

### 2-2. 仕組み化する

内部品質に関する改善は、細かい部分の議論が多くなりがちです。
そのような場合に、人間が判断するのではなく、自動で指摘されるようにすることで、無駄に感情コストをかける必要がなくなります。

また、規約が設定されていないと、結論を決められずに議論が無駄に長引いてしまうことがあるため、自動で規約を設定することが重要です。

具体的には、 PR での自動チェックとして以下のような内容を設定しました。

| 項目                         | 利用ツール                                                                                                                                                                                                        |
| ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 静的解析の指摘が増えていない | [SwiftLint](https://realm.github.io/SwiftLint/)、[SwiftFormat](https://github.com/nicklockwood/SwiftFormat)、[Android Lint](https://developer.android.com/studio/write/lint?hl=ja)、[detekt](https://detekt.dev/) |
| デッドコードが増えていない   | [Periphery](https://github.com/peripheryapp/periphery)、[Qodana](https://www.jetbrains.com/help/qodana/getting-started.html)                                                                                      |
| Typo が増えていない          | [CSpell](https://cspell.org/)                                                                                                                                                                                     |

:::message
途中からこのような仕組みを導入したため、導入時点の指摘は一旦 Baseline のような形で無視するようにました。
そのため、Baseline より指摘が増えていないことをチェックするようにしています。
:::

### 2-3. 文面で示す

内部品質改善に関する方針は、明文化しておくことが重要です。
明文化しておくことで、同じことを何度も説明する必要がなくなりますし、新規メンバーが入ってきた際にも、方針を理解しやすくなります。

例えば、以下のような内容を明文化しました。

> PR の修正行数はできるだけ少なくする。これにより、レビューの効率が向上し、問題が発見しやすくなるため、品質の維持が容易になります。

> プロダクトコードとテストコードは同時に修正します。

> PR には、修正した理由や背景を説明します。

### 2-4. 自ら行動して手本を示す

ミッションやマインドセットが滞りなく運用されるために、何度でもメンバーに働きかけをすることが重要です。
そのため、自らが実装する際に手本を見せたり、メンバーのコードレビュー時に指摘をすること繰り返すことで、メンバーに働きかけることができます。

具体的には以下のような取り組みを率先して行いました。

- コード中で分かりにくい箇所を発見したら、リファクタリングのタスクを起票しておく
- 実装時に、仕様の背景に関するコメントを残す
- コードレビュー時に、分かりやすさや既存のコードとの整合性について指摘する

## 3. 正しい方向に向かっていることの観測

### 3-1. 定量的なデータの収集と共有

内部品質に関する定量的なデータに関しては、定期的に収集してチームへ共有するようにしました。

![](/images/code-internal-quality/quantitative-metrics-dashboard.png)

例えば以下のようなデータです。

- 静的解析の指摘数
- 単体テストのカバレッジ
- Typo 数

よくある失敗として、定量的なデータを評価基準とすると、その評価基準にのみ最適化されてしまうことがあります。
定量的に収集できる内部品質のデータは、一部の指標に過ぎないため、その指標にのみ最適化されてしまうと、継続的な価値提供につながらないパターンがあります。

- コード品質が順調に維持・向上しているかを確認できるようになった
- 開発メンバーがコード品質のメトリクス(単体テストのコードカバレッジ)を意識する場面が見られた

### 3-2. フィードバックサイクルの確保

定性的な意見によるフィードバックサイクルも確保しておくことが重要です。

チームメンバーによる定性的な自己評価を定期的に実施しています。

![](/images/code-internal-quality/qualitative-research.png)

定性的な自己評価では、複数人からコードの内部品質に関して特定のトピックを改善したいという意見が上がってきました。
振り返りなどで詳細をヒアリングし、スプリント計画に組み込んでいます。

振り返りでは、Mad Glad Sad のフレームワークを用いています。

![](/images/code-internal-quality/retrospective.png)

## 最後に
