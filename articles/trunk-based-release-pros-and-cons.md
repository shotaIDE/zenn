---
title: "トランクベース開発におけるメリットとデメリット"
emoji: "⛴️"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["トランクベース開発"]
published: false
---

# はじめに

トランクベース開発は、シンプルかつ強力な開発方法です。

https://dora.dev/capabilities/trunk-based-development/

上手く運用できれば、開発チームのパフォーマンスを最大限引き出し、爆速の開発を実現できます。

しかし、実際にプロジェクトで運用してみると、メリットは大きいものも、それなりにデメリットもあると感じました。

本記事では、私が実際にトランクベース開発を導入し、運用している中で感じたメリットとデメリットを具体的なシーンを含めて簡単にまとめてみます。

# トランクベース開発の概要

トランクベース開発とは、1 つのメインブランチ（トランクブランチ）を中心に開発を進める方法です。

長期間生存するブランチマージの困難さ、一部のメンバーだけで修正を長期間管理することによる知見の偏在化、マージブロックによる開発スピードの鈍化など、よくある開発課題を解決できる手法です。

トランクベース開発では「数日以上の生存期間を持つブランチを許容しない」というルールを設けます。

# メリット

トランクブランチ開発は、生存期間の長いブランチを許容しないことが最大の特徴です。
Git-flow や GitLab-flow、GitHub-flow などのブランチ戦略と比較し、実際に感じた、メリット・デメリットを記載します。

## ブランチ管理が限りなく簡単になり、コストやリスクが低減する

トランクベース開発では、全ての開発用ブランチを 1 日程度以内にトランクブランチへマージします。
また、リリースのときにはトランクブランチからリリースブランチを切ることがあります。

つまり、数日以上の生存期間を持つブランチはトランクブランチとリリースブランチの 2 種類だけになります。
そのため、限りなく簡単なブランチ管理が可能になります。

これにより、以下のようなメリットがあります。

- ブランチ管理のコストがほとんどなくなり、機能開発などの価値提供に使うコストが増える
- マージ時のコンフリクトを解消する機会がほとんどなくなり、解消ミスによるリスクがほとんどなくなる
- ブランチ管理やコンフリクト解消は難易度が高く、特定の熟練したメンバーだけにコストが集中することを防げる

実際にプロジェクトでは、トランクベース開発の運用フローが安定しているここ半年間くらいは、コンフリクトを解消する機会がほとんどなくなりました。
また、コード修正をどのブランチにマージすればいいかなどのコミュニケーションがなくなり、ブランチ管理にわずらわされることがなくなりました。

## 1 本のブランチ上で開発、テスト、自動チェック(CI)を集中することで、これらのコストパフォーマンスを最大化できる

主要なブランチが複数存在しないため、1 本のブランチ上で開発、テスト、自動チェック(CI)を高サイクルに回すことが可能になります。
これにより、以下のようなメリットがあります。

- 高頻度で自動・手動リグレッションテストを回すことができ、常に一定の品質を担保しやすくなる
- 開発者が全員で 1 つの状態のコードを触るため、全員の知見が共有されやすくなる

プロジェクトでは以下のようなシーンがありました。

- リグレッションテストにより、一般ユーザーに公開されていない機能の開発により発生したデグレが早期に検知された
- 機能 A のコード修正がトランクブランチにマージされたあと、機能 B のビルドが通らなくなり、機能 B と機能 A の依存関係が新しく発覚した

## デプロイとロールアウトの分離が強制されることで、副次的に開発プロセスやプロダクトに柔軟性が生まれる

トランクベース開発では数日以上などの生存期間が長いブランチを許容しません。
その制約のため、機能開発の途中のコードをトランクブランチに逐次マージしていくことになり、そのコードが逐次デプロイされていくことになります。

そのため、機能開発のコードがデプロイされたとしても、その機能の発動を別の仕組みでコントロールできるようにする必要があります。

これにより、いくつかのメリットがあります。

- 開発プロセスの早い段階でデプロイのことを考える必要がある
- ロールアウトにおけるリスクに対してできることが増える
- ビジネス的な要求に対して対応しやすくなる
- ユーザーからのベータ機能のフィードバックなどの仕組みが容易に導入できる

例えばプロジェクトでは以下のようなシーンがありました。

- 「機能 A はサーバーへの負荷が心配だね。パーセンテージロールアウトして、もし問題が起きたらこの機能だけロールバックしようか。」

このように、リリースのリスクへの対策をしつつ、ユーザーへの価値提供を最大限引き出すことができます。

# デメリット

## デプロイとロールアウトを分離する必要があるため、開発の複雑性が増し、学習コストが高くなる

デプロイとロールアウトの分離を実施する場合、以下のように開発、テスト、運用などのプロセスがそれぞれ複雑化します。

- コード上でフィーチャートグルを管理し、ON/OFF 時の挙動の分岐を管理する
- テスト時にフィーチャートグル ON/OFF 両方の状態でテストを行う
- サーバー側でフィーチャートグルが動的に切り替える運用が想定される場合は、テスト時に ON と OFF 状態を行き来するパターンの挙動を確認する
- フィーチャートグルを切り替える運用が発生する
- フィーチャートグルを削除するメンテナンスを行う
- 監視やログの設計が複雑化する

これにより、プロセスの工数が少しずつ増え、メンバー間のコミュニケーションコストも少しずつ増えてきます。

具体的には以下のようなコミュニケーションが発生します。

- 「機能 A はフィーチャートグルを使って実装しましょう。フィーチャートグル OFF の場合は、機能 A が表示されないようにしてください。」
- 「今回のリリースに機能 B の途中までの修正が含まれますが、フィーチャートグル OFF 状態のままとするので、一般ユーザーには機能 B が見えることはありません。」
- 「今回のリリースには機能 C が含まれます。機能 C はフィーチャートグルを使って実装しているため、リリース時にフィーチャートグルを ON にする必要があります。」

さらに、プロダクトオーナーやビジネスサイドのメンバーにも説明が必要になってきます。

例えば、以下のようなコミュニケーションが発生します。

- 「機能 A は来週月曜日から 2 週間かけて一般ユーザーに徐々に開放されていきます。」
- 「機能 B は来週月曜日に全ユーザーへ公開されます。もし、監視で問題が発生した場合は、すぐに機能 B を無効化します。」

こうしたコミュニケーションは、プロダクトの外部への発信やユーザーへのサポートなどに必要です。

## 品質基準やリリース計画とは関係なくまぜこぜに修正が取り込まれていく

包括的な自動テストや高サイクルのリグレッションテストを回していても、バグは発生するものです。
そのように、十分にテストされていないコードやバグを含むコードがトランクブランチにマージされる状態は発生します。

これらが発生している状態だと、リリースのタイミングでバグが流出してしまうリスクが高まります。

そのように、テストを充分に行い品質を担保してから修正を取り込みたい場合には、トランクベース開発は向いていない可能性があります。

また、バグ修正のロールアウトをコントロールすることは難しいため、リリースタイミングを調整したい場合とは相性が悪いという問題もあります。

フィーチャートグルなどをでバグが修正されていない状態と修正されている状態を切り替えることは一般的に難しい場合が多いです。
これは、バグ修正は一般的に複雑なコード修正を伴うため、フィーチャートグルで管理するコストが高くなるためです。
また、再現性の問題で、フィーチャートグルの切り替えに伴う動作確認が難しい場合もあります。

トランクベース開発では、バグ対応は、順次リリースに入れていくということをプロダクトオーナーと握っておくのが良いでしょう。

一方で、バグ修正がユーザーの手元で適用されるタイミングを完全にコントロールしたいという場合には、トランクベース開発は向いていない可能性があります。

# メリットとデメリットの比較

上記で見てきたように、トランクベース開発は、開発プロセスや品質担保を効率的に実現でき、副次的な効果として価値単位の柔軟なロールアウトが可能になることで運用リスクの低減や価値検証の柔軟性が高まります。
一方で、プロジェクトに関わる全員に対してキャッチアップコストが増加し、リリースタイミングのコントロール性が低くなります。

そのため、新しいものがウェルカムな雰囲気であり、リリースタイミングを柔軟に調整可能なプロジェクトでは、このあたりのデメリットが問題になりにくいため、導入しやすいと言えます。

私が参加しているプロジェクトでは、元々新しいものを取り入れることに前向きな文化があるという部分が当てはまっており、メリットが大きいと予想していたため、トランクベース開発を導入しました。

一方でいま、バグ修正がユーザーの手元で適用されるタイミングを完全にコントロールしたいという要求が出てきていて、その部分に対してはデメリットが大きくなっていると感じています。
プロジェクトの全体的な業務フローを整理して、適切な運用方法を検討中です。

# 最後に

本記事では、私が実際にトランクベース開発を導入し、運用している中で感じたメリットとデメリットを記載してみました。

トランクベース開発を導入する際には、メリットとデメリットを踏まえて、適切な運用方法を検討してみてください。
