---
title: "å®Œå…¨ã«è‡ªå‹•ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ããƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ã‚‹å®Ÿé¨“"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ios", "android"]
published: false
---

# ã¯ã˜ã‚ã«

å€‹äººã‚¢ãƒ—ãƒªé–‹ç™ºã§ã¯ã€ç¢ºä¿ã§ãã‚‹ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã®æ™‚é–“ã®ä¸å®‰å®šã•ã«ã‚ˆã‚Šé–‹ç™ºã§ããªã„æœŸé–“ãŒç™ºç”Ÿã—ã‚„ã™ã„ã§ã™ã€‚
é–‹ç™ºã§ããªã„æœŸé–“ãŒç©ºãã¨ã€å†é–‹ã—ãŸæ™‚ã«åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å¤šããŒæœ€æ–°ã§ã¯ãªããªã£ã¦ã„ã¦ã€è¾›ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆä½œæ¥­ãŒç™ºç”Ÿã—ã¾ã™ã€‚

é–‹ç™ºã§ããªã„æœŸé–“ã§ã‚‚ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã¨ãã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒªãƒªãƒ¼ã‚¹ã‚’è‡ªå‹•åŒ–ã§ãã‚Œã°ã€å†é–‹ã—ãŸéš›ã®æ‰‹é–“ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã§ã‚ã‚‹ã¨ã„ã†å°è±¡ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€å®Œå…¨ã«è‡ªå‹•ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ããƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

# æ¦‚è¦

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã‚’ PR ä½œæˆã‹ã‚‰ãƒãƒ¼ã‚¸ã¾ã§è‡ªå‹•åŒ–ã—ã¦ãŠãã€ãƒ¡ã‚¤ãƒ³ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ãŒå®šæœŸçš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

ä¸Šè¨˜ã¨ã¯åˆ¥ã‚µã‚¤ã‚¯ãƒ«ã®è‡ªã‚‰å®šç¾©ã—ãŸé »åº¦ã§ã€è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã®å‡¦ç†ã‚’å‹•ã‹ã—ã¾ã™ã€‚
ã“ã‚Œã«ã¯ã€ãƒ“ãƒ«ãƒ‰ã¨ã‚¢ãƒ—ãƒªå¯©æŸ»æå‡ºã€å¯©æŸ»ãŒé€šã£ãŸã‚‰å…¬é–‹ã¨ã„ã†ä¸€é€£ã®æµã‚ŒãŒå«ã¾ã‚Œã¾ã™ã€‚

ã“ã®éš›ã€å„æ‰€ã§é™çš„è§£æã‚„è‡ªå‹•ãƒ†ã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€å“è³ªã‚’æ‹…ä¿ã—ã¦ãŠãã¾ã™ã€‚

ã¾ãŸã€ã‚¢ãƒ—ãƒªå¯©æŸ»çŠ¶æ³ã‚’ä¿æŒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’ç”¨æ„ã—ã€ã‚¢ãƒ—ãƒªå¯©æŸ»ä¸­ã«æ–°è¦ã§ã‚¢ãƒ—ãƒªå¯©æŸ»ã‚’æå‡ºã—ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

# å‰æ

ã‚¢ãƒ—ãƒªå…¬é–‹æ™‚ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå›ºå®šã®æ–‡è¨€ã‚’å®šç¾©ã—ã¦ãŠãã€ãã‚Œã‚’å…¨ã¦ã®ãƒªãƒªãƒ¼ã‚¹ã§é©ç”¨ã™ã‚‹ã¨ã„ã†å‰æã§ã™ã€‚

```text
ç´°ã‹ã„ãƒã‚°ä¿®æ­£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Šã‚’è¡Œã„ã¾ã—ãŸã€‚
```

# è©³ç´°ã®æ–¹é‡

æ¦‚è¦ã§ç¤ºã—ãŸé€šã‚Šã€å¤§ããåˆ†ã‘ã¦ä»¥ä¸‹ã® 2 ã¤ã®ã‚µã‚¤ã‚¯ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚

- ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ãŒå®šæœŸçš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
- è‡ªã‚‰å®šç¾©ã—ãŸé »åº¦ã§è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã®å‡¦ç†ã‚’å‹•ã‹ã™

## ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ãŒå®šæœŸçš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠã

ä»¥ä¸‹ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ãŒå®šæœŸçš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã® PR ãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
- é™çš„è§£æã¨å˜ä½“ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’ PR ã®ãƒãƒ¼ã‚¸ã«å¿…é ˆã®æ¡ä»¶ã¨ã™ã‚‹
- PR ã®ãƒãƒ¼ã‚¸å¿…é ˆæ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸå ´åˆã€è‡ªå‹•ã§ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

## è‡ªã‚‰å®šç¾©ã—ãŸé »åº¦ã§è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã®å‡¦ç†ã‚’å‹•ã‹ã™

ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ãƒ­ãƒ¼ã‚’çµ„ã¿ã¾ã™ã€‚

![](/images/automated-regular-release-for-mobile/automated-release-flow.png)

ä»¥ä¸‹ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã¦ã„ã¾ã™ã€‚

- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šæœŸçš„ã«è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã®å‡¦ç†ã‚’ã‚­ãƒƒã‚¯
- ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’è¦‹ã¦å‰ã®ãƒªãƒªãƒ¼ã‚¹ã®å¯©æŸ»ä¸­ã§ã¯ãªã„ã‹ã‚’åˆ¤å®šã™ã‚‹
- å‰å›ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰å·®åˆ†ãŒã‚ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹
- E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ãƒªãƒªãƒ¼ã‚¹ã®å¯©æŸ»ä¸­ã¨ãƒãƒ¼ã‚¯
- å•†ç”¨ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼†å¯©æŸ»æå‡º
- å¯©æŸ»ãŒé€šã‚Šå…¬é–‹ã•ã‚ŒãŸéš›ã«ã€ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿ã¨ãƒãƒ¼ã‚¯

ãƒˆãƒªã‚¬ãƒ¼ã®é »åº¦ã¯å¤‰æ•°ãªã®ã§ã€ã©ã®ç¨‹åº¦ã®é »åº¦ã§ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã‚‚ã„ã„ã‹ã‚’å…ƒã«æ±ºå®šã—ã¾ã™ã€‚

# å„è¦ç´ ã®åˆ©ç”¨æŠ€è¡“

ä»¥ä¸‹ã§ã€å„è¦ç´ ã®å…·ä½“çš„ãªåˆ©ç”¨æŠ€è¡“ã‚’ç°¡å˜ã«ç´¹ä»‹ã—ã¾ã™ã€‚

å‰æã¨ã—ã¦ã€GitHub ä¸Šã§é–‹ç™ºã—ã€CI/CD ã®åŸºç›¤ã¨ã—ã¦ GitHub Actions ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

å„ç¨®è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ Fastlane ã‚’åˆ©ç”¨ã—ã¦çµ„ã‚“ã§ã„ã¾ã™ã€‚

https://fastlane.tools/

ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¨ã—ã¦ã¯ Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã® PR ãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

dependabot ã‚’ä½¿ã„ã¾ã™ã€‚

https://docs.github.com/ja/code-security/dependabot/dependabot-version-updates/about-dependabot-version-updates

## é™çš„è§£æã¨å˜ä½“ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’ PR ã®ãƒãƒ¼ã‚¸ã«å¿…é ˆã®æ¡ä»¶ã¨ã™ã‚‹

PR ãŒæå‡ºã•ã‚ŒãŸã‚‰ GitHub Actions ã§é™çš„è§£æã‚„å˜ä½“ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

GitHub ã®ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã«ã¦ã€ã“ã‚Œã‚‰ã®é™çš„è§£æã‚„å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸ã®å¿…é ˆæ¡ä»¶ã¨ã—ã¦ãŠãã¾ã™ã€‚

https://docs.github.com/ja/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/managing-a-branch-protection-rule

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã€ã‚¢ãƒ—ãƒªå†…ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ä¸å¯ã«ãªã£ãŸã‚Š deprecated ã«ãªã£ãŸå ´åˆã¯ã€ã“ã“ã§è‡ªå‹•ã‚µã‚¤ã‚¯ãƒ«ãŒæ­¢ã¾ã‚Šã¾ã™ã€‚

## PR ã®ãƒãƒ¼ã‚¸å¿…é ˆæ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸå ´åˆã€è‡ªå‹•ã§ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

Mergify ã‚’åˆ©ç”¨ã—ã¦ dependabot ãŒæå‡ºã—ãŸ PR ã¯ã€å¿…é ˆæ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸã‚‰è‡ªå‹•ã§ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

https://mergify.com/

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Mergify ã®è¨­å®šã‚’å®šç¾©ã—ã¾ã™ã€‚

```yaml:.github/mergify.yml
pull_request_rules:
  - name: Automatic merge PRs from dependabot
    conditions:
      - "author = dependabot[bot]"
    actions:
      merge:
        method: merge
```

## ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šæœŸçš„ã«è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã®å‡¦ç†ã‚’ã‚­ãƒƒã‚¯

GitHub Actions ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒˆãƒªã‚¬ãƒ¼ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```yaml:.github/workflows/regular-release.yml
name: Regular release

on:
  schedule:
    - cron: '0 0 * * 1' # æ¯é€±æœˆæ›œæ—¥ã® AM 9:00 (JST)

jobs:
  # ...
```

https://docs.github.com/ja/actions/using-workflows/events-that-trigger-workflows#schedule

## ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’è¦‹ã¦å‰ã®ãƒªãƒªãƒ¼ã‚¹ã®å¯©æŸ»ä¸­ã§ã¯ãªã„ã‹ã‚’åˆ¤å®šã™ã‚‹

Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ç‰¹å®šã®ã‚»ãƒ«ã‚’èª­ã¿å–ã‚Šã€å‰å›ã®ãƒªãƒªãƒ¼ã‚¹ãŒå¯©æŸ»ä¸­ã§ãªã„ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚

äº‹å‰æº–å‚™ã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å…ƒã« GCP ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã€å¿…è¦ãªæ¨©é™ã‚’ä»˜ä¸ã—ãŸä¸Šã§ã€ã‚­ãƒ¼ã‚’ JSON å½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¾ã™ã€‚

https://github.com/gimite/google-drive-ruby/blob/master/doc/authorization.md#service-account

Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç”¨æ„ã—ã€Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ç·¨é›†ç”»é¢ã«ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç·¨é›†æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Fastlane ã§ Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä¾å­˜é–¢ä¿‚ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

```ruby:Gemfile
source 'https://rubygems.org'

gem 'google_drive'
```

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `fastlane/spreadsheet-service-account-key.json` ã«æ ¼ç´ã—ã¦ãŠãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã« Fastlane ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```ruby:Fastfile
require 'google_drive'

lane :check_mobile_apps_are_currently_released do
  target_spreadsheet_id = 'xxxx' # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã® https://docs.google.com/spreadsheets/d/xxxx/edit ã«ãŠã‘ã‚‹ xxxx ã®éƒ¨åˆ†
  sheet_name = 'å¯©æŸ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
  target_range = 'A1'
  released_value = 'iOS ã¨ Android ä¸¡æ–¹ã¨ã‚‚ãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿'

  service_account_key_json = File.read('spreadsheet-service-account-key.json')
  service_account_key = StringIO.new(service_account_key_json)
  session = GoogleDrive::Session.from_service_account_key(service_account_key)

  spreadsheet = session.spreadsheet_by_key(target_spreadsheet_id)
  sheet = spreadsheet.worksheet_by_title(sheet_name)
  latest_status = sheet[target_range]

  raise 'ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼' unless latest_status == released_value

  UI.success 'ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿ã§ã™ï¼'
end
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Fastlane ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ GitHub Actions ã§å®Ÿè¡Œã—ã¾ã™ã€‚

```yaml
# ...

jobs:
  check-apps-status:
    name: Check apps status
    runs-on: ubuntu-latest
    outputs:
      is-release-available: ${{ steps.check-apps-currently-released.outputs.is_released == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - name: Check apps currently released
        id: check-apps-currently-released
        run: |
          if bundle exec fastlane check_mobile_apps_are_currently_released; then
            # Fastlaneã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæˆåŠŸã—ãŸå ´åˆ
            echo "is_released=true" >> $GITHUB_OUTPUT
          else
            # Fastlaneã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆ
            echo "is_released=false" >> $GITHUB_OUTPUT
          fi
  next-job:
    needs: check-apps-status
    if: needs.check-apps-status.outputs.is-release-available
    # ...
```

ãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã‚‰ GitHub Actions ã®æ¬¡ã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## å‰å›ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰å·®åˆ†ãŒã‚ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹

ãƒªãƒªãƒ¼ã‚¹æ™‚ã«ä»˜ä¸ã•ã‚Œã‚‹ Git ã®ã‚¿ã‚°ã‚’å…ƒã«ã€æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã¾ã§ã®å·®åˆ†ã‚’ç¢ºèªã—ã€å·®åˆ†ãŒã‚ã‚‹å ´åˆã¯ãƒªãƒªãƒ¼ã‚¹ä½œæ¥­ã‚’é€²ã‚ã¾ã™ã€‚

ã“ã‚Œã«ã¯ã€GitHub Actions ã® Changed Files ã¨ã„ã†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

https://github.com/marketplace/actions/changed-files

```yaml
# ...

check-unreleased-diff:
  name: Check some diffs exist related to app
  runs-on: ubuntu-latest
  outputs:
    has-diff-related-to-app: ${{ steps.check-related-files.outputs.any_changed == 'true' }}
  steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0
    - name: Get latest RC tag name
      id: get-latest-rc-tag-name
      run: |
        latest_rc_tag_name="$(git describe --tags --abbrev=0 --match 'rc/*')"
        echo "Latest RC tag name: $latest_rc_tag_name"
        echo "tag-name=$latest_rc_tag_name" >> $GITHUB_OUTPUT
    - name: Check latest release is not based on latest commit
      id: check-latest-release-is-not-based-on-latest-commit
      run: |
        latest_release_commit_sha="$(git rev-list -n 1 HEAD)"
        latest_rc_tag_commit_sha="$(git rev-list -n 1 ${{ steps.get-latest-rc-tag-name.outputs.tag-name }})"
        if [ "$latest_release_commit_sha" = "$latest_rc_tag_commit_sha" ]; then
          echo "Latest release is based on the latest commit."
          echo "result=false" >> $GITHUB_OUTPUT
        else
          echo "Latest release is not based on latest commit."
          echo "result=true" >> $GITHUB_OUTPUT
        fi
    - name: Check related files
      id: check-related-files
      uses: tj-actions/changed-files@v42
      if: ${{ steps.check-latest-release-is-not-based-on-latest-commit.outputs.result == 'true' }}
      with:
        base_sha: ${{ steps.get-latest-rc-tag-name.outputs.tag-name }}
        files: |
          .maestro/**
          android/**
          ios/**
          lib/**
          test/**
          .tool-versions
          .xcode-version
          pubspec.lock
          pubspec.yaml
        sha: "HEAD"
```

## E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

Maestro Cloud ã¨ãã® GitHub Actions ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

https://cloud.mobile.dev/

GitHub Actions ã® Secrets ã«ãŠã‘ã‚‹ `MAESTRO_CLOUD_API_KEY` ã«ã€Maestro Cloud ã® API ã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚

```yaml
# ...

e2e-test-ios:
  name: E2E test iOS app
  runs-on: macos-14
  steps:
    - uses: actions/checkout@v4
    - name: Setup Flutter
      uses: ./.github/actions/setup-flutter
    - name: Setup Xcode
      uses: ./.github/actions/setup-xcode
    - name: Setup CocoaPods
      uses: ./.github/actions/setup-cocoapods
    - name: Setup Ruby
      uses: ./.github/actions/setup-ruby
    - name: Build iOS dev app
      run: bundle exec fastlane ios build_dev_for_simulator
    - uses: mobile-dev-inc/action-maestro-cloud@v1.8.1
      with:
        api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
        app-file: "build/ios/iphonesimulator/Runner.app"
        ios-version: 17
        device-locale: ja_JP
```

## ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ãƒªãƒªãƒ¼ã‚¹ã®å¯©æŸ»ä¸­ã¨ãƒãƒ¼ã‚¯

Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã€ãƒªãƒªãƒ¼ã‚¹ä½œæ¥­é–‹å§‹ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Fastlane ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```ruby:Fastfile
lane :update_mobile_apps_status_to_in_release_process do
  Dotenv.load '.env'

  target_spreadsheet_id = 'xxxx' # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã® https://docs.google.com/spreadsheets/d/xxxx/edit ã«ãŠã‘ã‚‹ xxxx ã®éƒ¨åˆ†
  sheet_name = 'å¯©æŸ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
  target_range = 'A1'
  in_release_process_value = 'iOS ã¨ Android ä¸¡æ–¹ã¨ã‚‚ãƒªãƒªãƒ¼ã‚¹é€²è¡Œä¸­'

  service_account_key_json = File.read('spreadsheet-service-account-key.json')
  service_account_key = StringIO.new(service_account_key_json)
  session = GoogleDrive::Session.from_service_account_key(service_account_key)

  spreadsheet = session.spreadsheet_by_key(target_spreadsheet_id)
  sheet = spreadsheet.worksheet_by_title(sheet_name)
  sheet[target_range] = in_release_process_value
  sheet.save
end
```

`spreadsheet-service-account-key.json` ã¯å‰è¿°ã®é€šã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

ã•ã‚‰ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Fastlane ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ GitHub Actions ã§å®Ÿè¡Œã—ã¾ã™ã€‚

GitHub Actions ã® Secrets ã« `SPREADSHEET_SERVICE_ACCOUNT_KEY_JSON_BASE64` ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
å€¤ã«ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚

```yaml
update-apps-status:
  name: Update apps status
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - name: Setup Ruby
      uses: ./.github/actions/setup-ruby
    - name: Generate service account key file
      run: echo ${{ secrets.SPREADSHEET_SERVICE_ACCOUNT_KEY_JSON_BASE64 }} | base64 -d > fastlane/spreadsheet-service-account-key.json
    - name: Update apps status
      run: bundle exec fastlane update_mobile_apps_status_to_in_release_process
```

## å•†ç”¨ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼†å¯©æŸ»æå‡º

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Fastlane ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```ruby:Fastfile
lane :deploy_and_submit_for_review do
  # ...
  # ã“ã“ã§ãƒ“ãƒ«ãƒ‰ã¨ã‚¢ãƒ—ãƒªå¯©æŸ»æå‡ºã‚’è¡Œã†
  # ...
end
```

## å¯©æŸ»ãŒé€šã‚Šå…¬é–‹ã•ã‚ŒãŸéš›ã«ã€ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿ã¨ãƒãƒ¼ã‚¯

ãƒªãƒªãƒ¼ã‚¹å®Œäº†ã®ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãŒæ¥ãŸéš›ã«ã€Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚

Zapier ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å¤‰æ›´æ™‚ã«ç™ºå‹•ã™ã‚‹ã€Apps Script ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

iOS ã¨ Android ä¸¡æ–¹ã¨ã‚‚ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥ãŒæƒã£ãŸå ´åˆã«ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚

```javascript:script.as
const summarySheetName = 'Summary';
const statusRange = 'A2';
const statusValueBothInReleaseProcess = 'iOS ã¨ Android ã®ä¸¡æ–¹ã¨ã‚‚ãƒªãƒªãƒ¼ã‚¹é€²è¡Œä¸­';
const statusValueOnlyOneSideInReleaseProcess = 'iOS ã¨ Android ã®ã„ãšã‚Œã‹ãŒãƒªãƒªãƒ¼ã‚¹é€²è¡Œä¸­';
const statusValueBothReleased = 'iOS ã¨ Android ã®ä¸¡æ–¹ã¨ã‚‚ãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿';

function checkLatestReleaseHasCompleted() {
  const status = getValueInRangeForSheetByName(summarySheetName, statusRange);

  const iosLastRow = getLastRowForSheetByName('iOS');

  const androidLastRow = getLastRowForSheetByName('Android');

  if (iosLastRow !== androidLastRow) {
    console.log(`Last row number is different: iOS = ${iosLastRow}, Android = ${androidLastRow}.`);
    console.log(`Release status is "${status}".`);

    if (status == statusValueBothInReleaseProcess) {
      console.log('The above means only one of either iOS or Android is in release process.');

      setValueInRangeForSheetByName(summarySheetName, statusRange, statusValueOnlyOneSideInReleaseProcess);
    }

    return;
  }

  console.log(`Last row number is same: iOS = ${iosLastRow}, Android = ${androidLastRow}.`);
  console.log(`Release status is "${status}".`);

  if (status == statusValueBothInReleaseProcess) {
    console.log('The above means that both of iOS and Android are in release process.');
    return;
  }

  console.log('The above means that both iOS and Android releases have been completed.');

  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const iosSheet = spreadsheet.getSheetByName('iOS');
  const iosLastRange = iosSheet.getRange(iosLastRow, 1);
  const iosLastReleaseMetaData = iosLastRange.getValue();
  const iosVersionNameRegex = /App Version Number: ([0-9]+\.[0-9]+\.[0-9]+)/;
  const matched = iosLastReleaseMetaData.match(iosVersionNameRegex);

  if (!matched && matched.length <= 1) {
    console.log(`Failed to extract version name from meta data: "${iosLastReleaseMetaData}".`);
  }

  const versionName = matched[1];
  console.log(`Found "${versionName}" release.`);

  setValueInRangeForSheetByName(summarySheetName, statusRange, statusValueBothReleased);
}

function getLastRowForSheetByName(sheetName) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getSheetByName(sheetName);
  return sheet.getLastRow();
}

function getValueInRangeForSheetByName(sheetName, range) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getSheetByName(sheetName);
  const targetRange = sheet.getRange(range);
  return targetRange.getValue();
}

function setValueInRangeForSheetByName(sheetName, range, value) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getSheetByName(sheetName);
  const targetRange = sheet.getRange(range);
  targetRange.setValue(value);
}
```
